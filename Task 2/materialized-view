-- DROP tables (for resetting up)
DROP MATERIALIZED VIEW planned_hours_calculations_mv;
DROP MATERIALIZED VIEW planned_versus_actual_hours_mv;

-- Use REPLACE MATERIALIZED VIEW <name> to refresh the table
-- Materialized view
CREATE MATERIALIZED VIEW planned_hours_calculations_mv AS 
With base AS ( -- temporary calculates stored hours
    SELECT
        -- renaming (AS) for the output
        c.course_code AS course_code,
        ci.instance_id AS course_instance_id,
        cl.hp AS hp,
        sp.period_code AS study_period,
        ci.num_students AS num_students,

        -- Sum of individual activity categories
        -- ROUND requires the data type in numeric, 2 = 2 decimals
        ROUND(SUM(CASE WHEN ta.activity_name = 'Lecture'
                THEN pa.planned_hours * ta.factor ELSE 0 END)::numeric, 2) AS lecture_hours,

        ROUND(SUM(CASE WHEN ta.activity_name = 'Tutorial'
                THEN pa.planned_hours * ta.factor ELSE 0 END)::numeric, 2) AS tutorial_hours,

        ROUND(SUM(CASE WHEN ta.activity_name = 'Lab'
                THEN pa.planned_hours * ta.factor ELSE 0 END)::numeric, 2) AS lab_hours,

        ROUND(SUM(CASE WHEN ta.activity_name = 'Seminar'
                THEN pa.planned_hours * ta.factor ELSE 0 END)::numeric, 2) AS seminar_hours,

        ROUND(SUM(CASE WHEN ta.activity_name = 'Other Overhead'
                THEN pa.planned_hours * ta.factor ELSE 0 END)::numeric, 2) AS other_overhead_hours

    FROM course_instance ci
    JOIN course_layout cl   ON cl.course_layout_id = ci.course_layout_id
    JOIN course c           ON c.course_id = cl.course_id
    JOIN study_period sp    ON sp.study_period_id = ci.study_period_id
    JOIN planned_activity pa  ON pa.course_instance_id = ci.course_instance_id
    JOIN teaching_activity ta ON ta.teaching_activity_id = pa.teaching_activity_id

    -- only current year's course instances
    WHERE ci.study_year = EXTRACT(YEAR FROM CURRENT_DATE)

    -- adds together SUM row
    GROUP BY 
        c.course_code,
        ci.instance_id,
        cl.hp,
        sp.period_code,
        ci.num_students
)

SELECT -- add derived hours and totals 
-- SQL does not allow alias to be used in the same SELECT list
    *, 
    ROUND((32 + 0.725 * num_students)::numeric, 2) AS exam_hours,
    ROUND((2 * hp + 28 + 0.2 * num_students)::numeric, 2) AS admin_hours, 

    ROUND(
        lecture_hours + tutorial_hours + lab_hours + seminar_hours + other_overhead_hours + 
        (32 + 0.725 * num_students) + (2 * hp + 28 + 0.2 * num_students) 
    ) AS total_hours

FROM base 
ORDER BY course_code, course_instance_id; 


CREATE MATERIALIZED VIEW planned_versus_actual_hours_mv AS 
CREATE VIEW planned_versus_actual_hours_view AS
With planned AS (
    SELECT 
        ci.instance_id AS course_instance_id,
        ROUND(SUM(pa.planned_hours * ta.factor)::numeric, 2) AS planned_hours
    FROM course_instance ci
    JOIN planned_activity pa ON pa.course_instance_id = ci.course_instance_id
    JOIN teaching_activity ta ON ta.teaching_activity_id = pa.teaching_activity_id

    -- Sum per instance id 
    GROUP BY 
    ci.instance_id
),
actual AS (
    SELECT 
        ci.instance_id AS course_instance_id,
        ROUND(SUM(epa.actual_allocated_hours * ta.factor)::numeric, 2) AS actual_hours
    FROM course_instance ci
    JOIN planned_activity pa ON pa.course_instance_id = ci.course_instance_id
    JOIN teaching_activity ta ON ta.teaching_activity_id = pa.teaching_activity_id
    JOIN employee_planned_activity epa ON epa.course_instance_id = ci.course_instance_id

    GROUP BY 
    ci.instance_id
)

SELECT 
    p.course_instance_id,
    p.planned_hours,
    a.actual_hours,
    ROUND(ABS(a.actual_hours - planned_hours) / p.planned_hours * 100, 2) AS variance_percent
FROM planned p 
JOIN actual a ON a.course_instance_id = p.course_instance_id
WHERE ROUND(ABS(a.actual_hours - p.planned_hours) / p.planned_hours * 100, 2) > 15;